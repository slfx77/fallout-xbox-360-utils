<?xml version="1.0" encoding="utf-8"?>

<UserControl
  x:Class="FalloutXbox360Utils.RepackerTab"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:local="using:FalloutXbox360Utils">

  <Grid VerticalAlignment="Stretch">
    <!--  Settings drawer  -->
    <Border
      x:Name="SettingsDrawer"
      Style="{StaticResource SettingsDrawerBorderStyle}">
      <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="16">
          <TextBlock Text="Settings" Style="{StaticResource SubtitleTextBlockStyle}" />
          <StackPanel Spacing="4">
            <TextBlock Text="Configuration" FontWeight="SemiBold" FontSize="13"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
            <CheckBox
              x:Name="UpdateUserIniCheckbox"
              x:Uid="Checkbox_UpdateUserIni"
              MinWidth="0" />
          </StackPanel>
        </StackPanel>
      </ScrollViewer>
    </Border>

    <!--  Main content  -->
    <Grid Padding="16"
          VerticalAlignment="Stretch">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>

      <!-- Header row -->
      <Grid Grid.Row="0"
            Margin="0,0,0,8">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>
        <StackPanel Style="{StaticResource TabHeaderStackPanelStyle}">
          <TextBlock
            x:Uid="Header_Repacker"
            Style="{StaticResource SubtitleTextBlockStyle}" />
          <TextBlock
            x:Uid="Subtitle_Repacker"
            Style="{StaticResource TabSubtitleStyle}" />
        </StackPanel>
        <StackPanel
          Grid.Column="1"
          Style="{StaticResource SelectButtonsPanelStyle}">
          <Button
            x:Uid="Button_SelectSource"
            Click="SelectSourceButton_Click" />
          <Button
            x:Uid="Button_SelectOutput"
            Click="SelectOutputButton_Click" />
        </StackPanel>
      </Grid>

      <!-- Source Info Card -->
      <Border
        x:Name="SourceInfoCard"
        Grid.Row="1"
        Margin="0,0,0,8"
        Style="{StaticResource CardBorderStyle}"
        Visibility="Collapsed">
        <Grid Padding="12">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>
          <StackPanel Grid.Column="0"
                      Orientation="Vertical"
                      Spacing="4">
            <StackPanel Orientation="Horizontal"
                        Spacing="8">
              <TextBlock x:Uid="Label_Source"
                         FontWeight="SemiBold" />
              <TextBlock x:Name="SourcePathText"
                         Text="-"
                         TextTrimming="CharacterEllipsis"
                         MaxWidth="400" />
            </StackPanel>
            <StackPanel Orientation="Horizontal"
                        Spacing="8">
              <TextBlock x:Uid="Label_Status"
                         FontWeight="SemiBold" />
              <FontIcon x:Name="ValidationIcon"
                        FontSize="14"
                        Glyph="&#xE73E;"
                        Foreground="Green"
                        VerticalAlignment="Center" />
              <TextBlock x:Name="ValidationText"
                         Text="Valid Xbox 360 installation"
                         Foreground="Green" />
            </StackPanel>
          </StackPanel>
          <StackPanel Grid.Column="1"
                      HorizontalAlignment="Center"
                      Orientation="Vertical"
                      Spacing="4">
            <StackPanel Orientation="Horizontal"
                        Spacing="8">
              <TextBlock x:Uid="Label_Output"
                         FontWeight="SemiBold" />
              <TextBlock x:Name="OutputPathText"
                         Text="(not selected)"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                         TextTrimming="CharacterEllipsis"
                         MaxWidth="400" />
            </StackPanel>
            <StackPanel Orientation="Horizontal"
                        Spacing="8">
              <TextBlock x:Uid="Label_TotalFiles"
                         FontWeight="SemiBold" />
              <TextBlock x:Name="TotalFilesText"
                         Text="0" />
            </StackPanel>
          </StackPanel>
          <StackPanel Grid.Column="2"
                      Orientation="Vertical"
                      Spacing="4">
            <StackPanel Orientation="Horizontal"
                        Spacing="8">
              <TextBlock x:Uid="Label_FFmpeg"
                         FontWeight="SemiBold" />
              <TextBlock x:Name="FfmpegStatusText"
                         Text="Available"
                         Foreground="Green" />
            </StackPanel>
          </StackPanel>
        </Grid>
      </Border>

      <!-- Categories Table -->
      <Grid Grid.Row="2"
            Margin="0,0,0,8"
            Visibility="{x:Bind SourceInfoCard.Visibility, Mode=OneWay}">
        <Border
          VerticalAlignment="Stretch"
          Style="{StaticResource CardBorderStyle}">
          <Grid VerticalAlignment="Stretch">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Column headers -->
            <Grid Grid.Row="0"
                  Style="{StaticResource ColumnHeaderGridStyle}">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="40" />
                <ColumnDefinition Width="150" />
                <ColumnDefinition Width="80" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="120" />
              </Grid.ColumnDefinitions>
              <TextBlock Grid.Column="0"
                         FontWeight="SemiBold"
                         Text="" />
              <TextBlock x:Uid="Col_Category"
                         Grid.Column="1"
                         FontWeight="SemiBold" />
              <TextBlock x:Uid="Label_Files"
                         Grid.Column="2"
                         FontWeight="SemiBold"
                         HorizontalAlignment="Right" />
              <TextBlock x:Uid="Col_Description"
                         Grid.Column="3"
                         FontWeight="SemiBold"
                         Margin="16,0,0,0" />
              <TextBlock x:Uid="Col_Status"
                         Grid.Column="4"
                         FontWeight="SemiBold"
                         HorizontalAlignment="Right" />
            </Grid>

            <!-- Categories ListView -->
            <ListView
              x:Name="CategoriesListView"
              Grid.Row="1"
              Style="{StaticResource FileListViewStyle}">
              <ListView.ItemTemplate>
                <DataTemplate x:DataType="local:RepackCategory">
                  <StackPanel>
                    <!-- Main category row -->
                    <Grid Style="{StaticResource ListItemRowGridStyle}">
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="40" />
                        <ColumnDefinition Width="150" />
                        <ColumnDefinition Width="80" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="120" />
                      </Grid.ColumnDefinitions>
                      <CheckBox
                        Grid.Column="0"
                        IsChecked="{x:Bind IsEnabled, Mode=TwoWay}"
                        IsEnabled="{x:Bind IsAvailable}" />
                      <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="{x:Bind Name}" VerticalAlignment="Center" />
                        <ToggleButton
                          IsChecked="{x:Bind IsExpanded, Mode=TwoWay}"
                          Visibility="{x:Bind HasSubItems, Mode=OneWay}"
                          Padding="4,2"
                          Margin="4,0,0,0"
                          Background="Transparent"
                          BorderThickness="0"
                          MinWidth="0"
                          MinHeight="0">
                          <FontIcon
                            Glyph="{x:Bind ExpanderGlyph, Mode=OneWay}"
                            FontSize="10"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                        </ToggleButton>
                      </StackPanel>
                      <TextBlock
                        Grid.Column="2"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Right"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        Text="{x:Bind FileCountDisplay, Mode=OneWay}" />
                      <TextBlock
                        Grid.Column="3"
                        VerticalAlignment="Center"
                        Margin="16,0,0,0"
                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                        Text="{x:Bind Description}"
                        TextTrimming="CharacterEllipsis"
                        ToolTipService.ToolTip="{x:Bind Description}" />
                      <TextBlock
                        Grid.Column="4"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Right"
                        Foreground="{x:Bind StatusColor, Mode=OneWay}"
                        Text="{x:Bind StatusDisplay, Mode=OneWay}" />
                    </Grid>
                    <!-- Sub-items for BSA files -->
                    <ItemsControl
                      ItemsSource="{x:Bind SubItems, Mode=OneWay}"
                      Visibility="{x:Bind SubItemsVisibility, Mode=OneWay}"
                      Margin="40,0,0,0">
                      <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="local:RepackBsaEntry">
                          <Grid Padding="0,2">
                            <Grid.ColumnDefinitions>
                              <ColumnDefinition Width="24" />
                              <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <CheckBox
                              Grid.Column="0"
                              IsChecked="{x:Bind IsSelected, Mode=TwoWay}"
                              Padding="0"
                              MinWidth="0" />
                            <TextBlock
                              Grid.Column="1"
                              VerticalAlignment="Center"
                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                              Text="{x:Bind FileName}" />
                          </Grid>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </StackPanel>
                </DataTemplate>
              </ListView.ItemTemplate>
            </ListView>
          </Grid>
        </Border>
      </Grid>

      <!-- Empty state when no source selected -->
      <Border
        x:Name="NoSourcePanel"
        Grid.Row="2"
        VerticalAlignment="Stretch"
        Style="{StaticResource CardBorderStyle}">
        <StackPanel HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="16">
          <FontIcon FontSize="64"
                    Glyph="&#xE777;"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
          <TextBlock x:Uid="EmptyRepacker_Title"
                     FontSize="18"
                     Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                     TextAlignment="Center" />
          <TextBlock x:Uid="EmptyRepacker_Subtitle"
                     Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                     TextAlignment="Center" />
          <Button x:Uid="Button_SelectSource"
                  HorizontalAlignment="Center"
                  Click="SelectSourceButton_Click"
                  Style="{StaticResource AccentButtonStyle}" />
        </StackPanel>
      </Border>

      <!-- Stats Card -->
      <Border
        x:Name="StatsCard"
        Grid.Row="3"
        Margin="0,8,0,0"
        Style="{StaticResource CardBorderStyle}"
        Visibility="Collapsed">
        <Grid Padding="12">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>
          <TextBlock x:Name="StatusText"
                     Grid.Column="0"
                     VerticalAlignment="Center"
                     Text="Ready to convert" />
          <TextBlock x:Name="SelectedCountText"
                     Grid.Column="1"
                     VerticalAlignment="Center"
                     Margin="16,0"
                     Text="5 categories selected" />
          <TextBlock x:Name="SelectedFilesText"
                     Grid.Column="2"
                     VerticalAlignment="Center"
                     Margin="16,0"
                     Text="0 files" />
        </Grid>
      </Border>

      <!-- Progress Bar -->
      <ProgressBar
        x:Name="ConversionProgress"
        Grid.Row="4"
        Margin="0,8,0,0"
        Maximum="100"
        Visibility="Collapsed" />

      <!-- Action Buttons -->
      <Grid Grid.Row="5"
            Margin="0,8,0,0">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <TextBlock x:Name="ProgressDetailText"
                   Grid.Column="0"
                   VerticalAlignment="Center"
                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                   TextTrimming="CharacterEllipsis" />

        <Button
          x:Name="CancelButton"
          x:Uid="Button_Cancel"
          Grid.Column="1"
          Margin="0,0,8,0"
          Click="CancelButton_Click"
          Visibility="Collapsed" />
        <Button
          x:Name="ConvertButton"
          x:Uid="Button_StartConversion"
          Grid.Column="2"
          Click="ConvertButton_Click"
          IsEnabled="False"
          Style="{StaticResource AccentButtonStyle}" />
      </Grid>
    </Grid>
  </Grid>
</UserControl>

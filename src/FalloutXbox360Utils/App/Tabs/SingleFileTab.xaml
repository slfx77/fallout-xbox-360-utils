<?xml version="1.0" encoding="utf-8"?>

<UserControl
  x:Class="FalloutXbox360Utils.SingleFileTab"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:controls="using:Microsoft.UI.Xaml.Controls"
  xmlns:hexviewer="using:FalloutXbox360Utils"
  xmlns:local="using:FalloutXbox360Utils">

  <Grid VerticalAlignment="Stretch">
    <!--  Settings drawer (hamburger-style, overlays from left)  -->
    <Border
      x:Name="SettingsDrawer"
      Style="{StaticResource SettingsDrawerBorderStyle}">
      <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="16">
          <TextBlock Text="Settings" Style="{StaticResource SubtitleTextBlockStyle}" />

          <!--  File Type Filters  -->
          <StackPanel Spacing="4">
            <TextBlock Text="File Types" FontWeight="SemiBold" FontSize="13"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
            <StackPanel
              x:Name="FileTypeCheckboxPanel"
              Spacing="2">
              <!--  Checkboxes will be generated dynamically  -->
            </StackPanel>
          </StackPanel>

          <!--  Conversion Options  -->
          <StackPanel Spacing="4">
            <TextBlock Text="Conversion" FontWeight="SemiBold" FontSize="13"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
            <CheckBox
              x:Name="ConvertDdxCheckBox"
              x:Uid="Checkbox_ConvertFormats"
              MinWidth="0"
              IsChecked="True" />
            <CheckBox
              x:Name="SaveAtlasCheckBox"
              x:Uid="Checkbox_SaveAtlas"
              MinWidth="0" />
          </StackPanel>

          <!--  Output Options  -->
          <StackPanel Spacing="4">
            <TextBlock Text="Output" FontWeight="SemiBold" FontSize="13"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
            <CheckBox
              x:Name="VerboseCheckBox"
              x:Uid="Checkbox_Verbose"
              MinWidth="0" />
          </StackPanel>
        </StackPanel>
      </ScrollViewer>
    </Border>

    <!--  Main content  -->
    <Grid Padding="16"
          VerticalAlignment="Stretch">
      <Grid.RowDefinitions>
        <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>

      <!--  Sub-Tab View  -->
      <controls:TabView x:Name="SubTabView" Grid.Row="0"
                        VerticalAlignment="Stretch"
                        IsAddTabButtonVisible="False" TabWidthMode="SizeToContent"
                        CanDragTabs="False" CanReorderTabs="False"
                        SelectionChanged="SubTabView_SelectionChanged">

        <!--  Tab 1: Memory Map  -->
        <controls:TabViewItem x:Uid="Tab_MemoryMap" IsClosable="False">
          <Grid VerticalAlignment="Stretch"
                HorizontalAlignment="Stretch">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" MinWidth="500" />
              <ColumnDefinition Width="8" />
              <ColumnDefinition Width="*" MinWidth="400" />
            </Grid.ColumnDefinitions>

            <!--  Hex Viewer  -->
            <Border Grid.Column="0"
                    VerticalAlignment="Stretch"
                    Style="{StaticResource DarkCardBorderStyle}">
              <hexviewer:HexViewerControl x:Name="HexViewer" />
            </Border>

            <controls:ContentPresenter Grid.Column="1" />

            <!--  Files Table + Filter  -->
            <Grid Grid.Column="2">
              <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
              </Grid.RowDefinitions>

              <Border Grid.Row="0"
                      VerticalAlignment="Stretch"
                      Style="{StaticResource CardBorderStyle}">
                <Grid VerticalAlignment="Stretch">
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                  </Grid.RowDefinitions>

                <!--  Column headers  -->
                <Grid Grid.Row="0"
                      Style="{StaticResource ColumnHeaderGridStyle}">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="90" />
                    <ColumnDefinition Width="70" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="50" />
                  </Grid.ColumnDefinitions>
                  <Button Grid.Column="0"
                          Style="{StaticResource SortableColumnHeaderButtonStyle}"
                          Click="SortByOffset_Click">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock x:Uid="Col_Offset" FontWeight="SemiBold" />
                      <FontIcon x:Name="OffsetSortIcon"
                                Style="{StaticResource SortIconStyle}" />
                    </StackPanel>
                  </Button>
                  <Button Grid.Column="1"
                          Style="{StaticResource SortableColumnHeaderButtonStyle}"
                          Click="SortByLength_Click">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock x:Uid="Col_Size" FontWeight="SemiBold" />
                      <FontIcon x:Name="LengthSortIcon"
                                Style="{StaticResource SortIconStyle}" />
                    </StackPanel>
                  </Button>
                  <Button Grid.Column="2"
                          Style="{StaticResource SortableColumnHeaderButtonStyle}"
                          Click="SortByType_Click">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock x:Uid="Col_Type" FontWeight="SemiBold" />
                      <FontIcon x:Name="TypeSortIcon"
                                Style="{StaticResource SortIconStyle}" />
                    </StackPanel>
                  </Button>
                  <Button Grid.Column="3"
                          Style="{StaticResource SortableColumnHeaderButtonStyle}"
                          Click="SortByFilename_Click">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <TextBlock x:Uid="Col_Filename" FontWeight="SemiBold" />
                      <FontIcon x:Name="FilenameSortIcon"
                                Style="{StaticResource SortIconStyle}" />
                    </StackPanel>
                  </Button>
                  <TextBlock Grid.Column="4" FontWeight="SemiBold" Text="" />
                </Grid>

                <!--  File list  -->
                <ListView x:Name="ResultsListView"
                          Grid.Row="1"
                          RightTapped="ResultsListView_RightTapped"
                          SelectionChanged="ResultsListView_SelectionChanged"
                          SelectionMode="Single">
                  <ListView.ContextFlyout>
                    <MenuFlyout x:Name="FileListContextMenu">
                      <MenuFlyoutItem x:Name="GoToStartMenuItem" x:Uid="Menu_GoToStart"
                                      Click="GoToStart_Click">
                        <MenuFlyoutItem.Icon>
                          <FontIcon Glyph="&#xE76B;" />
                        </MenuFlyoutItem.Icon>
                      </MenuFlyoutItem>
                      <MenuFlyoutItem x:Name="GoToEndMenuItem" x:Uid="Menu_GoToEnd"
                                      Click="GoToEnd_Click">
                        <MenuFlyoutItem.Icon>
                          <FontIcon Glyph="&#xE76C;" />
                        </MenuFlyoutItem.Icon>
                      </MenuFlyoutItem>
                      <MenuFlyoutSeparator />
                      <MenuFlyoutItem x:Name="CopyOffsetMenuItem" x:Uid="Menu_CopyOffset"
                                      Click="CopyOffset_Click">
                        <MenuFlyoutItem.Icon>
                          <FontIcon Glyph="&#xE8C8;" />
                        </MenuFlyoutItem.Icon>
                      </MenuFlyoutItem>
                      <MenuFlyoutItem x:Name="CopyFilenameMenuItem" x:Uid="Menu_CopyFilename"
                                      Click="CopyFilename_Click">
                        <MenuFlyoutItem.Icon>
                          <FontIcon Glyph="&#xE8C8;" />
                        </MenuFlyoutItem.Icon>
                      </MenuFlyoutItem>
                    </MenuFlyout>
                  </ListView.ContextFlyout>
                  <ListView.ItemTemplate>
                    <DataTemplate x:DataType="local:CarvedFileEntry">
                      <Grid Padding="8,4">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="90" />
                          <ColumnDefinition Width="70" />
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="50" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" FontFamily="Consolas" FontSize="11"
                                   Text="{x:Bind OffsetHex}" />
                        <TextBlock Grid.Column="1" FontSize="11"
                                   Text="{x:Bind LengthFormatted}" />
                        <TextBlock Grid.Column="2" FontSize="11"
                                   Text="{x:Bind DisplayType}"
                                   TextTrimming="CharacterEllipsis"
                                   ToolTipService.ToolTip="{x:Bind DisplayType}" />
                        <TextBlock Grid.Column="3" FontSize="11"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   Text="{x:Bind FileNameDisplay}"
                                   TextTrimming="CharacterEllipsis"
                                   ToolTipService.ToolTip="{x:Bind FileNameDisplay}" />
                        <FontIcon Grid.Column="4" HorizontalAlignment="Center" FontSize="12"
                                  Foreground="{x:Bind ExtractedColor, Mode=OneWay}"
                                  Glyph="{x:Bind ExtractedGlyph, Mode=OneWay}" />
                      </Grid>
                    </DataTemplate>
                  </ListView.ItemTemplate>
                </ListView>

              </Grid>
              </Border>

              <!--  Type filter dropdown (below the card)  -->
              <DropDownButton x:Name="FilterDropDown"
                              Grid.Row="1"
                              Content="Filter: All types"
                              FontSize="11"
                              HorizontalAlignment="Left"
                              Margin="0,4,0,0"
                              Visibility="Collapsed">
                <DropDownButton.Flyout>
                  <Flyout Placement="BottomEdgeAlignedLeft">
                    <Flyout.FlyoutPresenterStyle>
                      <Style TargetType="FlyoutPresenter">
                        <Setter Property="Background"
                                Value="{ThemeResource CardBackgroundSolidBrush}" />
                      </Style>
                    </Flyout.FlyoutPresenterStyle>
                    <StackPanel Spacing="4" MinWidth="240">
                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <HyperlinkButton Content="Select all" Padding="0"
                                         FontSize="11"
                                         Click="FilterSelectAll_Click" />
                        <HyperlinkButton Content="Clear" Padding="0"
                                         FontSize="11"
                                         Click="FilterSelectNone_Click" />
                      </StackPanel>
                      <ScrollViewer MaxHeight="400"
                                    VerticalScrollBarVisibility="Auto">
                        <StackPanel x:Name="ResultsFilterPanel" Spacing="0" />
                      </ScrollViewer>
                    </StackPanel>
                  </Flyout>
                </DropDownButton.Flyout>
              </DropDownButton>
            </Grid>
          </Grid>
        </controls:TabViewItem>

        <!--  Tab 2: Data Browser  -->
        <controls:TabViewItem x:Name="DataBrowserTab" x:Uid="Tab_DataBrowser"
                              IsClosable="False">
          <Grid Padding="0,16,0,0">
            <!--  Placeholder: loading indicator  -->
            <StackPanel x:Name="DataBrowserPlaceholder"
                        HorizontalAlignment="Center" VerticalAlignment="Center"
                        Spacing="12">
              <ProgressBar x:Name="ReconstructProgressBar"
                           IsIndeterminate="False" Value="0"
                           Width="200" Visibility="Collapsed"
                           Style="{StaticResource TabProgressBarStyle}" />
              <TextBlock x:Name="ReconstructStatusText" x:Uid="Empty_RunAnalysis"
                         HorizontalAlignment="Center"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
              <Button x:Name="ReconstructButton" x:Uid="Button_ReconstructRecords"
                      Click="ReconstructButton_Click"
                      Visibility="Collapsed"
                      Style="{StaticResource AccentButtonStyle}" />
            </StackPanel>

            <!--  Browser content: toolbar + tree + properties  -->
            <Grid x:Name="DataBrowserContent" Visibility="Collapsed">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" MinWidth="350" />
                <ColumnDefinition Width="3*" />
              </Grid.ColumnDefinitions>

              <!--  Left: search + sort + tree  -->
              <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Search bar  -->
                <TextBox x:Name="EsmSearchBox" x:Uid="Input_EsmSearch"
                         Grid.Row="0"
                         Margin="0,0,0,8"
                         TextChanged="EsmSearchBox_TextChanged" />

                <!--  Sort controls  -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8"
                            Margin="0,0,0,8">
                  <TextBlock x:Uid="Label_Sort" VerticalAlignment="Center" FontSize="12"
                             Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                  <ComboBox x:Name="EsmSortComboBox"
                            MinWidth="140"
                            SelectedIndex="0"
                            SelectionChanged="EsmSortComboBox_SelectionChanged">
                    <ComboBoxItem x:Uid="Sort_ByName" />
                    <ComboBoxItem x:Uid="Sort_ByEditorId" />
                    <ComboBoxItem x:Uid="Sort_ByFormId" />
                  </ComboBox>
                </StackPanel>

                <!--  Tree view (shown when no search)  -->
                <TreeView x:Name="EsmTreeView"
                          Grid.Row="2"
                          CanDragItems="False"
                          CanReorderItems="False"
                          Expanding="EsmTreeView_Expanding"
                          ItemInvoked="EsmTreeView_ItemInvoked"
                          SelectionMode="Single">
                  <TreeView.ItemTemplate>
                    <DataTemplate>
                      <Grid>
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="Auto" />
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <FontIcon Grid.Column="0" FontSize="12"
                                  Glyph="{Binding Content.IconGlyph}"
                                  Margin="0,0,6,0" />
                        <TextBlock Grid.Column="1" FontSize="12"
                                   Text="{Binding Content.DisplayName}"
                                   TextTrimming="CharacterEllipsis"
                                   Margin="0,0,6,0" />
                        <TextBlock Grid.Column="2" FontSize="11"
                                   HorizontalAlignment="Left"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   Text="{Binding Content.Detail}"
                                   TextTrimming="CharacterEllipsis" />
                      </Grid>
                    </DataTemplate>
                  </TreeView.ItemTemplate>
                </TreeView>
              </Grid>

              <!--  Property detail panel  -->
              <Grid Grid.Column="1" Padding="12,0,0,0">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Grid Grid.Row="0" Margin="0,0,0,8">
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                  </Grid.RowDefinitions>
                  <StackPanel Orientation="Horizontal" Grid.Row="0" Spacing="0">
                    <TextBlock x:Name="SelectedRecordTitle" x:Uid="Empty_SelectRecord"
                               Style="{StaticResource SubtitleTextBlockStyle}"
                               VerticalAlignment="Center"
                               TextWrapping="Wrap"
                               MaxLines="2"
                               TextTrimming="CharacterEllipsis" />
                  </StackPanel>
                  <Button x:Name="GoToOffsetButton" x:Uid="Button_GoToOffset"
                          Grid.Row="1"
                          Margin="0,8,0,0"
                          Click="GoToRecordOffset_Click"
                          Visibility="Collapsed" />
                  <Button x:Name="ViewWorldspaceButton" Grid.Row="2"
                          Content="View Worldspace"
                          Click="ViewWorldspace_Click"
                          Visibility="Collapsed"
                          Margin="0,8,0,0"
                          ToolTipService.ToolTip="View this worldspace in the World tab" />
                </Grid>

                <Border Grid.Row="1" CornerRadius="4"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                  <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="8">
                    <StackPanel x:Name="PropertyPanel" Spacing="2" />
                  </ScrollViewer>
                </Border>
              </Grid>
            </Grid>
          </Grid>
        </controls:TabViewItem>

        <!--  Tab 3: Dialogue Viewer  -->
        <controls:TabViewItem x:Name="DialogueViewerTab"
                              Header="Dialogue Viewer"
                              IsClosable="False">
          <Grid Padding="0,16,0,0">
            <!--  Placeholder (shown before population)  -->
            <StackPanel x:Name="DialogueViewerPlaceholder"
                        HorizontalAlignment="Center" VerticalAlignment="Center"
                        Spacing="12">
              <TextBlock x:Name="DialogueViewerStatusText"
                         Text="Run analysis on an ESM or DMP file to view dialogues"
                         HorizontalAlignment="Center"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
              <ProgressBar x:Name="DialogueViewerProgressBar"
                           Width="300" Visibility="Collapsed"
                           IsIndeterminate="True" />
            </StackPanel>

            <!--  Main content: picker + conversation  -->
            <Grid x:Name="DialogueViewerContent" Visibility="Collapsed">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350" MinWidth="280" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>

              <!--  LEFT PANEL: Quest/NPC picker  -->
              <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Search bar  -->
                <TextBox x:Name="DialogueSearchBox"
                         Grid.Row="0" Margin="0,0,8,8"
                         PlaceholderText="Search quests, topics, dialogue..."
                         TextChanged="DialogueSearchBox_TextChanged" />

                <!--  Browse mode toggle  -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8"
                            Margin="0,0,8,8">
                  <TextBlock Text="Browse by:" VerticalAlignment="Center" FontSize="12"
                             Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                  <ComboBox x:Name="DialogueBrowseMode"
                            MinWidth="120" SelectedIndex="0"
                            SelectionChanged="DialogueBrowseMode_SelectionChanged">
                    <ComboBoxItem Content="Quest" />
                    <ComboBoxItem Content="NPC" />
                  </ComboBox>
                </StackPanel>

                <!--  Picker tree  -->
                <TreeView x:Name="DialoguePickerTree"
                          Grid.Row="2" Margin="0,0,8,0"
                          CanDragItems="False" CanReorderItems="False"
                          SelectionMode="Single"
                          Expanding="DialoguePickerTree_Expanding"
                          ItemInvoked="DialoguePickerTree_ItemInvoked">
                  <TreeView.ItemTemplate>
                    <DataTemplate>
                      <Grid>
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="Auto" />
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <FontIcon Grid.Column="0" FontSize="12"
                                  Glyph="{Binding Content.IconGlyph}"
                                  Margin="0,0,6,0" />
                        <TextBlock Grid.Column="1" FontSize="12"
                                   Text="{Binding Content.DisplayName}"
                                   TextTrimming="CharacterEllipsis"
                                   Margin="0,0,6,0" />
                        <TextBlock Grid.Column="2" FontSize="11"
                                   HorizontalAlignment="Left"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   Text="{Binding Content.Detail}"
                                   TextTrimming="CharacterEllipsis" />
                      </Grid>
                    </DataTemplate>
                  </TreeView.ItemTemplate>
                </TreeView>
              </Grid>

              <!--  RIGHT PANEL: Conversation view  -->
              <Grid Grid.Column="1" Padding="12,0,0,0">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="*" />
                  <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!--  Header with back button  -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="0"
                            Margin="0,0,0,8">
                  <TextBlock x:Name="DialogueHeaderText"
                             Text="Select a topic from the left panel"
                             Style="{StaticResource SubtitleTextBlockStyle}"
                             VerticalAlignment="Center"
                             TextWrapping="Wrap" MaxLines="2"
                             TextTrimming="CharacterEllipsis" />
                </StackPanel>

                <!--  Conversation scroll area  -->
                <ScrollViewer x:Name="DialogueConversationScroller"
                              Grid.Row="1"
                              VerticalScrollBarVisibility="Auto">
                  <StackPanel x:Name="DialogueConversationPanel" Spacing="8"
                              Padding="0,0,8,0" />
                </ScrollViewer>

                <!--  Player choices panel  -->
                <Border Grid.Row="2"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="4" Padding="8" Margin="0,8,0,0"
                        MaxHeight="350">
                  <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel x:Name="DialogueChoicesPanel" Spacing="4">
                      <TextBlock x:Name="DialogueChoicesHeader"
                                 Text="Your responses:"
                                 FontSize="12" FontWeight="SemiBold"
                                 Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                 Visibility="Collapsed" />
                    </StackPanel>
                  </ScrollViewer>
                </Border>
              </Grid>
            </Grid>
          </Grid>
        </controls:TabViewItem>

        <!--  Tab 4: World Map  -->
        <controls:TabViewItem x:Name="WorldMapTab" Header="World"
                              IsClosable="False">
          <Grid Padding="0,8,0,0">
            <!--  Placeholder  -->
            <StackPanel x:Name="WorldMapPlaceholder"
                        HorizontalAlignment="Center" VerticalAlignment="Center"
                        Spacing="12">
              <TextBlock x:Name="WorldMapStatusText" Text="Run analysis to view world data"
                         HorizontalAlignment="Center"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
              <ProgressBar x:Name="WorldMapProgressBar"
                           Width="300" Visibility="Collapsed"
                           IsIndeterminate="True" />
            </StackPanel>

            <!--  World map content  -->
            <Grid x:Name="WorldMapContent" Visibility="Collapsed">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="600" />
                <ColumnDefinition Width="350" />
              </Grid.ColumnDefinitions>

              <!--  Left: Win2D map  -->
              <local:WorldMapControl x:Name="WorldMapControl" Grid.Column="0"
                                     InspectObject="WorldMap_InspectObject"
                                     InspectCell="WorldMap_InspectCell" />

              <!--  Right: Object detail panel  -->
              <Grid Grid.Column="1" Padding="12,0,0,0">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <TextBlock x:Name="WorldObjectTitle" Grid.Row="0"
                           Text="Click an object to inspect"
                           Style="{StaticResource SubtitleTextBlockStyle}"
                           Margin="0,0,0,8" />

                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8"
                            Margin="0,0,0,8">
                  <Button x:Name="ViewBaseInBrowserButton"
                          Content="View in Data Browser"
                          Click="ViewBaseInBrowser_Click"
                          Visibility="Collapsed"
                          ToolTipService.ToolTip="View the base record in the Data Browser" />
                </StackPanel>

                <Border Grid.Row="2" CornerRadius="4"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                  <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="8">
                    <StackPanel x:Name="WorldPropertyPanel" Spacing="2" />
                  </ScrollViewer>
                </Border>
              </Grid>
            </Grid>
          </Grid>
        </controls:TabViewItem>

        <!--  Tab 5: Reports  -->
        <controls:TabViewItem x:Name="ReportsTab" x:Uid="Tab_Reports"
                              IsClosable="False">
          <Grid Padding="16">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  Top bar: Export buttons  -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8"
                        Margin="0,0,0,8">
              <Button x:Name="ExportSelectedReportButton" x:Uid="Button_ExportSelected"
                      Click="ExportSelectedReport_Click"
                      IsEnabled="False" />
              <Button x:Name="ExportAllReportsButton" x:Uid="Button_ExportAll"
                      Click="ExportAllReports_Click"
                      IsEnabled="False" />
            </StackPanel>

            <!--  Search bar  -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8"
                        Margin="0,0,0,8">
              <TextBox x:Name="ReportSearchBox" x:Uid="Input_ReportSearch"
                       Width="250"
                       KeyDown="ReportSearchBox_KeyDown" />
              <Button x:Uid="Button_FindNext" Click="ReportSearchNext_Click" />
              <Button x:Uid="Button_FindPrev" Click="ReportSearchPrev_Click" />
              <TextBlock x:Name="ReportSearchStatus"
                         VerticalAlignment="Center"
                         FontSize="12"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
            </StackPanel>

            <!--  Report list + preview  -->
            <Grid Grid.Row="2">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>

              <ListView x:Name="ReportListView"
                        Grid.Column="0"
                        SelectionChanged="ReportListView_SelectionChanged"
                        SelectionMode="Single">
                <ListView.ItemTemplate>
                  <DataTemplate x:DataType="local:ReportEntry">
                    <StackPanel Padding="4,2" Spacing="2">
                      <TextBlock FontSize="12" FontWeight="SemiBold"
                                 Text="{x:Bind FileName}" />
                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontSize="11"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   Text="{x:Bind ReportType}" />
                        <TextBlock FontSize="11"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   Text="{x:Bind SizeFormatted}" />
                      </StackPanel>
                    </StackPanel>
                  </DataTemplate>
                </ListView.ItemTemplate>
              </ListView>

              <Grid Grid.Column="1" Margin="12,0,0,0">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox x:Name="ReportPreviewTextBox"
                         Grid.Column="0"
                         FontFamily="Consolas" FontSize="11"
                         IsReadOnly="True"
                         AcceptsReturn="True"
                         TextWrapping="NoWrap"
                         ScrollViewer.VerticalScrollBarVisibility="Disabled"
                         ScrollViewer.HorizontalScrollBarVisibility="Auto"
                         SizeChanged="ReportPreviewTextBox_SizeChanged"
                         PointerWheelChanged="ReportPreviewTextBox_PointerWheelChanged" />
                <ScrollBar x:Name="ReportViewerScrollBar"
                           Grid.Column="1"
                           Orientation="Vertical"
                           Maximum="0"
                           ViewportSize="50"
                           SmallChange="1"
                           LargeChange="10"
                           ValueChanged="ReportViewerScrollBar_ValueChanged" />
              </Grid>
            </Grid>
          </Grid>
        </controls:TabViewItem>

        <!--  Tab 6: Summary (File Info + Coverage/Record Breakdown)  -->
        <controls:TabViewItem x:Name="SummaryTab" x:Uid="Tab_Summary"
                              IsClosable="False">
          <Grid Padding="16">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  File Info Card (full width)  -->
            <Border Grid.Row="0" Style="{StaticResource CardBorderStyle}"
                    Margin="0,0,0,16">
              <Grid Padding="12">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!--  Column 1: File identity  -->
                <StackPanel Grid.Column="0" Spacing="4">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="File" FontWeight="SemiBold" />
                    <TextBlock x:Name="InfoFileName"
                               TextTrimming="CharacterEllipsis"
                               MaxWidth="300" />
                  </StackPanel>
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Size" FontWeight="SemiBold" />
                    <TextBlock x:Name="InfoFileSize" />
                  </StackPanel>
                </StackPanel>

                <!--  Column 2: Format details  -->
                <StackPanel Grid.Column="1" Spacing="4">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Format" FontWeight="SemiBold" />
                    <TextBlock x:Name="InfoFormat" />
                  </StackPanel>
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Endianness" FontWeight="SemiBold" />
                    <TextBlock x:Name="InfoEndianness" />
                  </StackPanel>
                </StackPanel>

                <!--  Column 3: Build info (minidumps only)  -->
                <StackPanel x:Name="InfoBuildPanel" Grid.Column="2" Spacing="4"
                            Visibility="Collapsed">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Module" FontWeight="SemiBold" />
                    <TextBlock x:Name="InfoModuleName" />
                  </StackPanel>
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Compiled" FontWeight="SemiBold" />
                    <TextBlock x:Name="InfoCompileDate" />
                  </StackPanel>
                </StackPanel>
              </Grid>
            </Border>

            <!--  Record breakdown (ESM and DMP files)  -->
            <ScrollViewer x:Name="SummaryRecordPanel" Grid.Row="1" Visibility="Collapsed"
                          VerticalScrollBarVisibility="Auto">
              <StackPanel x:Name="RecordBreakdownPanel" Spacing="12" />
            </ScrollViewer>
          </Grid>
        </controls:TabViewItem>

        <!--  Tab 7: Coverage  -->
        <controls:TabViewItem x:Name="CoverageTab" x:Uid="Tab_Coverage"
                              IsClosable="False">
          <Grid Padding="16">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="400" />
              <ColumnDefinition Width="16" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!--  Left column: Summary + Classification  -->
            <ScrollViewer Grid.Column="0"
                          VerticalScrollBarVisibility="Auto">
              <StackPanel Spacing="16">
                <TextBlock x:Uid="Label_CoverageSummary" Style="{StaticResource SubtitleTextBlockStyle}" />
                <TextBlock x:Name="CoverageSummaryText" x:Uid="Empty_RunCoverage"
                           FontFamily="Consolas" FontSize="12"
                           TextWrapping="Wrap" />

                <TextBlock x:Uid="Label_GapClassification" Style="{StaticResource SubtitleTextBlockStyle}" />
                <TextBlock x:Name="CoverageClassificationText"
                           FontFamily="Consolas" FontSize="12"
                           TextWrapping="Wrap" />
              </StackPanel>
            </ScrollViewer>

            <!--  Right column: Sortable Gap Details  -->
            <Grid Grid.Column="2">
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
              </Grid.RowDefinitions>

              <TextBlock x:Uid="Label_GapDetails" Grid.Row="0"
                         Style="{StaticResource SubtitleTextBlockStyle}"
                         Margin="0,0,0,8" />

              <!--  Sortable column headers  -->
              <Grid Grid.Row="1" Padding="8,4" Margin="0,0,0,4">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="50" />
                  <ColumnDefinition Width="110" />
                  <ColumnDefinition Width="90" />
                  <ColumnDefinition Width="140" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Button Grid.Column="0"
                        Style="{StaticResource SortableColumnHeaderButtonStyle}"
                        Click="CoverageSortByIndex_Click">
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock FontSize="11" FontWeight="SemiBold" Text="#" />
                    <FontIcon x:Name="CoverageIndexSortIcon"
                              Style="{StaticResource SortIconStyle}" />
                  </StackPanel>
                </Button>
                <Button Grid.Column="1"
                        Style="{StaticResource SortableColumnHeaderButtonStyle}"
                        Click="CoverageSortByOffset_Click">
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock x:Uid="Col_FileOffset" FontSize="11" FontWeight="SemiBold" />
                    <FontIcon x:Name="CoverageOffsetSortIcon"
                              Style="{StaticResource SortIconStyle}" />
                  </StackPanel>
                </Button>
                <Button Grid.Column="2"
                        Style="{StaticResource SortableColumnHeaderButtonStyle}"
                        Click="CoverageSortBySize_Click">
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock x:Uid="Col_Size" FontSize="11" FontWeight="SemiBold" />
                    <FontIcon x:Name="CoverageSizeSortIcon"
                              Style="{StaticResource SortIconStyle}" />
                  </StackPanel>
                </Button>
                <Button Grid.Column="3"
                        Style="{StaticResource SortableColumnHeaderButtonStyle}"
                        Click="CoverageSortByClassification_Click">
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock x:Uid="Col_Classification" FontSize="11" FontWeight="SemiBold" />
                    <FontIcon x:Name="CoverageClassSortIcon"
                              Style="{StaticResource SortIconStyle}" />
                  </StackPanel>
                </Button>
                <TextBlock x:Uid="Col_Context" Grid.Column="4" FontSize="11" FontWeight="SemiBold" />
              </Grid>

              <!--  Gap list  -->
              <ListView x:Name="CoverageGapListView"
                        Grid.Row="2"
                        SelectionChanged="CoverageGapListView_SelectionChanged"
                        SelectionMode="Single" />
            </Grid>
          </Grid>
        </controls:TabViewItem>

      </controls:TabView>

      <!--  Progress Bars  -->
      <ProgressBar
        x:Name="AnalysisProgressBar"
        Grid.Row="1"
        IsIndeterminate="True"
        Style="{StaticResource TabProgressBarStyle}" />
      <ProgressBar
        x:Name="ReportsProgressBar"
        Grid.Row="1"
        IsIndeterminate="False" Value="0"
        Visibility="Collapsed"
        Style="{StaticResource TabProgressBarStyle}" />

      <!--  Input/Output Section  -->
      <Grid
        Grid.Row="2"
        Style="{StaticResource IoSectionGridStyle}">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!--  Minidump Path  -->
        <TextBlock
          x:Uid="Label_MinidumpPath"
          Grid.Row="0"
          Grid.Column="0"
          Style="{StaticResource IoLabelStyle}" />
        <TextBox
          x:Name="MinidumpPathTextBox"
          x:Uid="Input_MinidumpPath"
          Grid.Row="0"
          Grid.Column="1"
          Style="{StaticResource IoTextBoxStyle}"
          AllowDrop="True"
          TextChanged="MinidumpPathTextBox_TextChanged" />
        <Button
          x:Uid="Button_Browse"
          Grid.Row="0"
          Grid.Column="2"
          Click="OpenMinidumpButton_Click" />
        <Button
          x:Name="AnalyzeButton"
          x:Uid="Button_Analyze"
          Grid.Row="0"
          Grid.Column="3"
          MinWidth="120"
          Margin="8,0,0,0"
          Click="AnalyzeButton_Click"
          IsEnabled="False"
          Style="{StaticResource AccentButtonStyle}" />

        <!--  Output Directory  -->
        <TextBlock
          x:Uid="Label_OutputDirectory"
          Grid.Row="1"
          Grid.Column="0"
          Style="{StaticResource IoLabelStyle}" />
        <TextBox
          x:Name="OutputPathTextBox"
          x:Uid="Input_OutputPath"
          Grid.Row="1"
          Grid.Column="1"
          Style="{StaticResource IoTextBoxStyle}"
          AllowDrop="True"
          TextChanged="OutputPathTextBox_TextChanged" />
        <Button
          x:Uid="Button_Browse"
          Grid.Row="1"
          Grid.Column="2"
          Click="BrowseOutputButton_Click" />
        <Button
          x:Name="ExtractButton"
          x:Uid="Button_Extract"
          Grid.Row="1"
          Grid.Column="3"
          MinWidth="120"
          Margin="8,0,0,0"
          Click="ExtractButton_Click"
          IsEnabled="False"
          Style="{StaticResource AccentButtonStyle}" />
      </Grid>
    </Grid>
  </Grid>
</UserControl>

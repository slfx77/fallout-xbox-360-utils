<?xml version="1.0" encoding="utf-8"?>

<UserControl
  x:Class="FalloutXbox360Utils.WorldMapControl"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:canvas="using:Microsoft.Graphics.Canvas.UI.Xaml">

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!-- Toolbar -->
    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Padding="0,0,0,8">
      <Button x:Name="BackButton" Click="BackButton_Click"
              Visibility="Collapsed" ToolTipService.ToolTip="Back">
        <FontIcon Glyph="&#xE72B;" FontSize="12" />
      </Button>
      <Button x:Name="ForwardButton" Click="ForwardButton_Click"
              Visibility="Collapsed" ToolTipService.ToolTip="Forward">
        <FontIcon Glyph="&#xE72A;" FontSize="12" />
      </Button>
      <ComboBox x:Name="WorldspaceComboBox" MinWidth="220"
                SelectionChanged="WorldspaceComboBox_SelectionChanged"
                PlaceholderText="Select Worldspace" />
      <Button x:Name="InteriorsButton" Content="Interiors"
              Click="InteriorsButton_Click"
              ToolTipService.ToolTip="Browse interior cells" />
      <Button x:Name="AllCellsButton" Content="All Cells"
              Click="AllCellsButton_Click"
              ToolTipService.ToolTip="Browse all cells" />
      <Button Content="Fit" Click="ZoomFit_Click"
              ToolTipService.ToolTip="Zoom to fit" />
      <TextBlock x:Name="ZoomLevelText" VerticalAlignment="Center" FontSize="11"
                 Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
    </StackPanel>

    <!-- Win2D Canvas -->
    <canvas:CanvasControl x:Name="MapCanvas" Grid.Row="1"
                          Draw="MapCanvas_Draw"
                          PointerPressed="MapCanvas_PointerPressed"
                          PointerMoved="MapCanvas_PointerMoved"
                          PointerReleased="MapCanvas_PointerReleased"
                          PointerWheelChanged="MapCanvas_PointerWheelChanged" />

    <!-- Legend overlay (floating above canvas, bottom-left) -->
    <Border x:Name="LegendOverlay" Grid.Row="1"
            VerticalAlignment="Bottom" HorizontalAlignment="Left"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            CornerRadius="4" Padding="6,4" Margin="8,0,0,8"
            Opacity="0.92">
      <StackPanel Spacing="0">
        <Button x:Name="LegendToggleButton" Click="LegendToggle_Click"
                HorizontalAlignment="Left"
                Background="Transparent" BorderThickness="0"
                Padding="4,2" MinHeight="0" MinWidth="0">
          <StackPanel Orientation="Horizontal" Spacing="4">
            <FontIcon x:Name="LegendToggleIcon" Glyph="&#xE70D;" FontSize="10" />
            <TextBlock Text="Legend" FontSize="10" VerticalAlignment="Center" />
          </StackPanel>
        </Button>
        <StackPanel x:Name="LegendPanel" Spacing="3" Margin="0,4,0,0" />
      </StackPanel>
    </Border>

    <!-- Cell Browser (shown instead of canvas when "All Cells" or "Interiors" is selected) -->
    <Grid x:Name="CellBrowserPanel" Grid.Row="1" Visibility="Collapsed">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>
      <TextBox x:Name="CellSearchBox" Grid.Row="0" PlaceholderText="Search cells..."
               TextChanged="CellSearchBox_TextChanged" Margin="0,0,0,4" />
      <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="12" Margin="0,0,0,4">
        <CheckBox x:Name="FilterHasObjects" Content="Has objects"
                  Checked="CellFilter_Changed" Unchecked="CellFilter_Changed" />
        <CheckBox x:Name="FilterNamedOnly" Content="Named only"
                  Checked="CellFilter_Changed" Unchecked="CellFilter_Changed" />
      </StackPanel>
      <ListView x:Name="CellListView" Grid.Row="2"
                SelectionMode="Single"
                SelectionChanged="CellListView_SelectionChanged">
        <ListView.GroupStyle>
          <GroupStyle>
            <GroupStyle.HeaderTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding Key}" FontSize="13" FontWeight="Bold"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
              </DataTemplate>
            </GroupStyle.HeaderTemplate>
          </GroupStyle>
        </ListView.GroupStyle>
        <ListView.ItemTemplate>
          <DataTemplate>
            <Grid Padding="4,2" ColumnSpacing="12">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="70" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>
              <TextBlock Grid.Column="0" FontSize="11" FontFamily="Consolas"
                         Text="{Binding GridLabel}" />
              <TextBlock Grid.Column="1" FontSize="11"
                         Text="{Binding DisplayName}" TextTrimming="CharacterEllipsis" />
              <TextBlock Grid.Column="2" FontSize="11" FontFamily="Consolas"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                         Text="{Binding ObjectCount}" />
            </Grid>
          </DataTemplate>
        </ListView.ItemTemplate>
      </ListView>
      <Button x:Name="ViewCellButton" Grid.Row="3" Content="View Cell"
              Click="ViewCellButton_Click" Visibility="Collapsed"
              Margin="0,4,0,0"
              ToolTipService.ToolTip="View this cell in detail mode" />
    </Grid>

    <!-- Status bar -->
    <Grid Grid.Row="2" Padding="0,4,0,0">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>
      <TextBlock x:Name="HoverInfoText" Grid.Column="0" FontSize="11"
                 Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
      <TextBlock x:Name="CoordsText" Grid.Column="1" FontSize="11" FontFamily="Consolas"
                 Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
    </Grid>
  </Grid>
</UserControl>
